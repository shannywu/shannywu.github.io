<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>[Airflow] Using the KubernetesPodOperator on Cloud Composer | learning notes</title><link rel="stylesheet" type="text/css" href="/blog/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><link rel="apple-touch-icon" href="/blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/blog/apple-touch-icon.png"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-68820773-2','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">[Airflow] Using the KubernetesPodOperator on Cloud Composer</h1><a id="logo" href="/blog/.">learning notes</a><p class="description"></p></div><div id="nav-menu"><a href="/blog/." class="current"><i class="fa fa-home"> Home</i></a><a href="/blog/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/blog/about/"><i class="fa fa-user"> About</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">[Airflow] Using the KubernetesPodOperator on Cloud Composer</h1><div class="post-meta">Apr 19, 2020<span> | </span><span class="category"><a href="/blog/categories/Data-Engineering/">Data Engineering</a></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Build-Container-Images-with-Google-Cloud-Build"><span class="toc-number">1.</span> <span class="toc-text">Build Container Images with Google Cloud Build</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Build-config-file"><span class="toc-number">1.1.</span> <span class="toc-text">Build config file</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Build-command"><span class="toc-number">1.2.</span> <span class="toc-text">Build command</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Create-Kubernetes-Secrets"><span class="toc-number">2.</span> <span class="toc-text">Create Kubernetes Secrets</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Creating-a-Secret-Using-kubectl"><span class="toc-number">2.1.</span> <span class="toc-text">Creating a Secret Using kubectl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Define-Secret-in-DAG"><span class="toc-number">2.2.</span> <span class="toc-text">Define Secret in DAG</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-the-KubernetesPodOperator"><span class="toc-number">3.</span> <span class="toc-text">Using the KubernetesPodOperator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">4.</span> <span class="toc-text">Reference</span></a></li></ol></div></div><div class="post-content"><p>Cloud Composer is a fully managed version of the open source workflow tool Apache Airflow on Google Cloud Platform (GCP). To run docker container from Cloud Composer, one of the way is to use the <code>KubernetesPodOperator</code>, which can launch Kubernetes pods into Kubernetes.</p>
<p>This post will cover these topics:</p>
<ul>
<li>Build container images with Google Cloud Build</li>
<li>Create Kubernetes Secrets</li>
<li>Using the <code>KubernetesPodOperator</code></li>
</ul>
<a id="more"></a>
<h2 id="Build-Container-Images-with-Google-Cloud-Build"><a href="#Build-Container-Images-with-Google-Cloud-Build" class="headerlink" title="Build Container Images with Google Cloud Build"></a>Build Container Images with Google Cloud Build</h2><p>Google Cloud Build is a fully managed solution for building containers or other artifacts. It can import source code from Google Cloud Storage, Cloud Source Repositories, GitHub and BitBucket.</p>
<h3 id="Build-config-file"><a href="#Build-config-file" class="headerlink" title="Build config file"></a>Build config file</h3><p>A build pipeline can be easily set up by a YAML or json file in the same directory that contains the application source code and the Dockerfile. Build steps are defined in this config file. For example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="attr">steps:</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">'gcr.io/cloud-builders/docker'</span></div><div class="line"><span class="attr">    id:</span> <span class="string">'build-image'</span></div><div class="line"><span class="attr">    args:</span> <span class="string">['build',</span> <span class="string">'-t'</span><span class="string">,</span> <span class="string">'gcr.io/my_project/my_image'</span><span class="string">,</span> <span class="string">'.'</span><span class="string">]</span></div><div class="line"><span class="attr">  - name:</span> <span class="string">'gcr.io/cloud-builders/docker'</span></div><div class="line"><span class="attr">    id:</span> <span class="string">'push-image'</span></div><div class="line"><span class="attr">    args:</span> <span class="string">['push',</span> <span class="string">'gcr.io/my_project/my_image'</span><span class="string">]</span></div></pre></td></tr></table></figure>
<p>There are two steps defined in the config file. Cloud Build provides some pre-build images (base images), named <a href="https://cloud.google.com/cloud-build/docs/cloud-builders" target="_blank" rel="external">Cloud Builders</a>. In the example file above, the <code>name</code> field specifies that the pre-build Docker image is used by Cloud Build, and the <code>args</code> field are the args passing to the image for execution.</p>
<h3 id="Build-command"><a href="#Build-command" class="headerlink" title="Build command"></a>Build command</h3><p>Starting the build with:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ gcloud builds submit --config [CONFIG_FILE_PATH] [SOURCE_DIRECTORY]</div></pre></td></tr></table></figure>
<p>When the build completes, Cloud Build will upload the built image to the container registry. You can also pass in parameters (called substitutions) to the build and customize some build options such as image tags. For more details, please read the <a href="https://cloud.google.com/cloud-build/docs/building/build-containers" target="_blank" rel="external">documentation</a>.</p>
<h2 id="Create-Kubernetes-Secrets"><a href="#Create-Kubernetes-Secrets" class="headerlink" title="Create Kubernetes Secrets"></a>Create Kubernetes Secrets</h2><p>A Secret object contains a small amount of sensitive data such as a password, a token, or a key. To use a secret, a Pod needs to reference the secret.</p>
<h3 id="Creating-a-Secret-Using-kubectl"><a href="#Creating-a-Secret-Using-kubectl" class="headerlink" title="Creating a Secret Using kubectl"></a>Creating a Secret Using kubectl</h3><p>To create a Kubernetes secret that sets tha value of <code>my_secret</code> to <code>test_value</code>, run the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ kubectl create secret generic airflow-secret \</div><div class="line">--from-literal my_secret=test_value</div></pre></td></tr></table></figure>
<p>If you need to mount a secret file, you can create your secret use:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ kubectl create secret generic airflow-secret-file \</div><div class="line">--from-file my_secret_file=file_path.json</div></pre></td></tr></table></figure>
<p>Note that the scrects cannot be access from different namespace.</p>
<h3 id="Define-Secret-in-DAG"><a href="#Define-Secret-in-DAG" class="headerlink" title="Define Secret in DAG"></a>Define Secret in DAG</h3><p>To reference the built secret in a DAG as an environment variable, you can use the following code:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> airflow.contrib.kubernetes <span class="keyword">import</span> secret</div><div class="line"></div><div class="line">my_secret_obj = secret.Secret(</div><div class="line">    deploy_type=<span class="string">'env'</span>,</div><div class="line">    deploy_target=<span class="string">'MY_SECRET'</span>,</div><div class="line">    secret=<span class="string">'airflow-secret'</span>,</div><div class="line">    key=<span class="string">'my_secret'</span></div><div class="line">)</div></pre></td></tr></table></figure>
<ul>
<li><code>deploy_type</code>: The exposing type of the Secret.</li>
<li><code>deploy_target</code>: Name of the environment variable, since deploy_type is <code>env</code> rather than <code>volume</code>.</li>
<li><code>secret</code>: Name of the built Kubernetes Secret.</li>
<li><code>key</code>: Key name of a secret stored in this Secret object.</li>
</ul>
<p>In this example, there is a built Secret object named <code>airflow-secret</code>, one of the key stored in this Secret object is called <code>my_secret</code>. The object will be deployed to kubernetes Pods as an enviornment variable, and the key of the variable is <code>MY_SECRET</code>.</p>
<p>To reference the built secret file:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> airflow.contrib.kubernetes <span class="keyword">import</span> secret</div><div class="line"></div><div class="line">my_secret_file_obj = secret.Secret(</div><div class="line">    deploy_type=<span class="string">'volume'</span>,</div><div class="line">    deploy_target=<span class="string">'/path/to/secret/file'</span>,</div><div class="line">    secret=<span class="string">'airflow-secret-file'</span></div><div class="line">)</div></pre></td></tr></table></figure>
<p>Note that the completed mount path will be <code>/path/to/secret/file/file_path.json</code>.</p>
<p>Also, you need to define the secret to pass to Pod. The way to pass it will be covered in the next section.</p>
<h2 id="Using-the-KubernetesPodOperator"><a href="#Using-the-KubernetesPodOperator" class="headerlink" title="Using the KubernetesPodOperator"></a>Using the <code>KubernetesPodOperator</code></h2><p>Let’s take a look into an example first:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> airflow.contrib.operators <span class="keyword">import</span> kubernetes_pod_operator</div><div class="line"></div><div class="line">my_pod_operator = kubernetes_pod_operator.KubernetesPodOperator(</div><div class="line">    task_id=<span class="string">'run-container'</span>,</div><div class="line">    name=<span class="string">'container-test'</span>,</div><div class="line">    namespace=<span class="string">'default'</span>,</div><div class="line">    image=<span class="string">'gcr.io/my_project/my_image'</span>,</div><div class="line">    secrets=[my_secret_obj],</div><div class="line">    arguments=[<span class="string">'--arg1=test'</span>],</div><div class="line">    env_vars=&#123;</div><div class="line">        <span class="string">'ENV_VAR'</span>: <span class="string">'&#123;&#123; var.value.my_var &#125;&#125;'</span></div><div class="line">    &#125;</div><div class="line">)</div></pre></td></tr></table></figure>
<ul>
<li><code>task_id</code>: ID specified for the task.</li>
<li><code>name</code>: Name of task you want to run, used to generate Pod ID.</li>
<li><code>namespace</code>: Namespace to run within Kubernetes, default namespace is <code>default</code>.</li>
<li><code>image</code>: The docker image to use. In our case, it’s the image built in section <a href="#Build-Container-Images-with-Google-Cloud-Build">Build Container Images with Google Cloud Build</a>.</li>
<li><code>secrets</code>: Name of the Kubernetes Secret, defined in section <a href="#Define-Secret-in-DAG">Define Secret in DAG</a>. The Pod will fail to create if the secrets you specify in a Secret object do not exist in Kubernetes.</li>
<li><code>arguments</code>: Arguments to the entrypoint, jinja template is allowed.</li>
<li><code>env_vars</code>: To access the variables defined in Airflow UI. In this case we are getting the value of <code>my_var</code> from the UI and pass it to the environment variable <code>ENV_VAR</code>.<br><img src="https://codingdiarysite.files.wordpress.com/2020/05/95923588_582506115951684_3965362202805796864_n.png" alt="Set environment variable through Airflow UI"></li>
</ul>
<p>For more information about each configuration variable, see the <a href="https://airflow.apache.org/docs/stable/_api/airflow/contrib/operators/kubernetes_pod_operator/index.html" target="_blank" rel="external">Airflow reference</a>.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="https://cloud.google.com/composer/docs/how-to/using/using-kubernetes-pod-operator" target="_blank" rel="external">Using the KubernetesPodOperator</a></li>
<li><a href="https://cloud.google.com/composer/docs/faq" target="_blank" rel="external">Cloud Composer FAQs</a></li>
<li><a href="https://kubernetes.io/docs/concepts/configuration/secret/" target="_blank" rel="external">Kubernetes Secrets</a></li>
</ul>
</div><div class="tags"><a href="/blog/tags/Airflow/">Airflow</a><a href="/blog/tags/Data-Engineering/">Data Engineering</a><a href="/blog/tags/Cloud-Composer/">Cloud Composer</a><a href="/blog/tags/GCP/">GCP</a></div><div class="post-nav"><a href="/blog/2020/04/03/airflow-scheduling/" class="next">[Airflow] Scheduling</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://shannywu.github.io/blog"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/2020/04/19/airflow-kubernetes-pod-operator-cloud-composer/">[Airflow] Using the KubernetesPodOperator on Cloud Composer</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2020/04/03/airflow-scheduling/">[Airflow] Scheduling</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/02/16/spark-job-on-amazon-emr/">[Spark] Run Spark Job on Amazon EMR</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/11/22/python-nltk-tools/">[Python] NLTK 工具整理</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/07/26/windows-flask-mod-wsgi-apache-on-windows/">Flask + mod_wsgi + Apache on Windows</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/07/17/python-nltk-wordnet/">[Python] NLTK and WordNet</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/06/16/tools-tmux-a-terminal-multiplexer/">tmux - A terminal multiplexer</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/05/24/mda-ch9-recommendation-systems/">[Massive Data Analysis] Recommendation Systems</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/05/24/mda-ch8-advertising-on-the-web/">[Massive Data Analysis] Advertising on the Web</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2016/05/23/mda-chapter-7-clustering/">[Massive Data Analysis] Clustering</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Data-Engineering/">Data Engineering</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Lecture-Notes/">Lecture Notes</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Miscellaneous/">Miscellaneous</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Python/">Python</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/blog/tags/flask/" style="font-size: 15px;">flask</a> <a href="/blog/tags/nltk/" style="font-size: 15px;">nltk</a> <a href="/blog/tags/re/" style="font-size: 15px;">re</a> <a href="/blog/tags/standford-parser/" style="font-size: 15px;">standford parser</a> <a href="/blog/tags/wordnet/" style="font-size: 15px;">wordnet</a> <a href="/blog/tags/linux/" style="font-size: 15px;">linux</a> <a href="/blog/tags/sort/" style="font-size: 15px;">sort</a> <a href="/blog/tags/grep/" style="font-size: 15px;">grep</a> <a href="/blog/tags/zgrep/" style="font-size: 15px;">zgrep</a> <a href="/blog/tags/edit-distance/" style="font-size: 15px;">edit distance</a> <a href="/blog/tags/spelling-correction/" style="font-size: 15px;">spelling correction</a> <a href="/blog/tags/collocation/" style="font-size: 15px;">collocation</a> <a href="/blog/tags/Linggle/" style="font-size: 15px;">Linggle</a> <a href="/blog/tags/map-reduce/" style="font-size: 15px;">map reduce</a> <a href="/blog/tags/pattern-grammar/" style="font-size: 15px;">pattern grammar</a> <a href="/blog/tags/WriteAhead/" style="font-size: 15px;">WriteAhead</a> <a href="/blog/tags/filter/" style="font-size: 15px;">filter</a> <a href="/blog/tags/lambda/" style="font-size: 15px;">lambda</a> <a href="/blog/tags/map/" style="font-size: 15px;">map</a> <a href="/blog/tags/match/" style="font-size: 15px;">match</a> <a href="/blog/tags/search/" style="font-size: 15px;">search</a> <a href="/blog/tags/reduce/" style="font-size: 15px;">reduce</a> <a href="/blog/tags/tmux/" style="font-size: 15px;">tmux</a> <a href="/blog/tags/apache/" style="font-size: 15px;">apache</a> <a href="/blog/tags/mod-wsgi/" style="font-size: 15px;">mod_wsgi</a> <a href="/blog/tags/windows/" style="font-size: 15px;">windows</a> <a href="/blog/tags/Airflow/" style="font-size: 15px;">Airflow</a> <a href="/blog/tags/Data-Engineering/" style="font-size: 15px;">Data Engineering</a> <a href="/blog/tags/Cloud-Composer/" style="font-size: 15px;">Cloud Composer</a> <a href="/blog/tags/GCP/" style="font-size: 15px;">GCP</a> <a href="/blog/tags/Spark/" style="font-size: 15px;">Spark</a> <a href="/blog/tags/EMR/" style="font-size: 15px;">EMR</a> <a href="/blog/tags/AWS/" style="font-size: 15px;">AWS</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/blog/." rel="nofollow">learning notes.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/blog/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/blog/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/blog/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/blog/js/smartresize.js?v=0.0.0"></script></div></body></html>